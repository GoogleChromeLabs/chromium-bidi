# This workflow will run headful and headless E2E tests.

name: E2E tests

# Declare default permissions as read only.
permissions: read-all

env:
  DEBUG: 'bidi:server:*,bidi:mapper:*'
  DEBUG_DEPTH: 10
  FORCE_COLOR: 3
  PIP_DISABLE_PIP_VERSION_CHECK: 1

on:
  merge_group:
  pull_request:
  push:
    branches: 'main'
  workflow_dispatch:
    inputs:
      verbose:
        description: Verbose logging
        default: true
        required: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  e2e-required:
    name: '[Required] e2e sink'
    needs: [e2e]
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    steps:
      - if: ${{ needs.e2e.result != 'success' }}
        run: 'exit 1'
      - run: 'exit 0'
  e2e:
    name: ${{ matrix.kind }}-${{ matrix.os }}-${{ matrix.head }}-${{ matrix.this_chunk }}-${{ matrix.this_repeat }}
    strategy:
      fail-fast: false
      matrix:
        # TODO(#876): Add Windows CI.
        # os: [macos-latest]
        os: [ubuntu-latest]
        # head: [headful, 'new-headless', 'old-headless']
        head: ['new-headless']
        # `cd` runs e2e via `chromedriver`. `node` runs tests using `NodeJS` runner.
        # kind: [cd, node]
        kind: [node]
        total_chunks: [3]
        this_chunk: [0, 1, 2]
        # `REPEAT_TESTS` in e2e does not work with snapshots, so need to repeat it manually.
        total_repeat_tests: [40]
        this_repeat:
          [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            11,
            12,
            13,
            14,
            15,
            16,
            17,
            18,
            19,
            20,
            21,
            22,
            23,
            24,
            25,
            26,
            27,
            28,
            29,
            30,
            31,
            32,
            33,
            34,
            35,
            36,
            37,
            38,
            39,
          ]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Set up Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version-file: '.nvmrc'
          cache: npm
      - name: Disable AppArmor
        if: ${{ matrix.os == 'ubuntu-latest' }}
        # https://chromium.googlesource.com/chromium/src/+/main/docs/security/apparmor-userns-restrictions.md
        run: echo 0 | sudo tee /proc/sys/kernel/apparmor_restrict_unprivileged_userns
      - uses: google/wireit@f21db1f3a6a4db31f42787a958cf2a18308effed # setup-github-actions-caching/v2.0.3
      - name: Install and build npm dependencies
        run: npm ci
      # Install chrome, chromedriver and headless shell is required to keep them cached.
      - name: Install all chrome binaries if needed
        uses: ./.github/actions/setup-chrome-binaries
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.11'
          cache: pipenv
      - name: Install pipenv
        run: pip install pipenv
      - name: Install python dependencies
        run: pipenv install
      - name: Run E2E tests
        if: matrix.os == 'ubuntu-latest' && matrix.head == 'headful'
        timeout-minutes: 20
        run: >
          xvfb-run --auto-servernum
          npm run e2e:${{ matrix.head }}
          --
          --this-chunk=${{ matrix.this_chunk }}
          --total-chunks=${{ matrix.total_chunks }}
        env:
          VERBOSE: true
          CHROMEDRIVER: ${{ matrix.kind == 'cd' }}
      - name: Run E2E tests
        if: matrix.os != 'ubuntu-latest' || matrix.head != 'headful'
        timeout-minutes: 20
        run: >
          npm run e2e:${{ matrix.head }}
          --
          --this-chunk=${{ matrix.this_chunk }}
          --total-chunks=${{ matrix.total_chunks }}
        env:
          VERBOSE: true
          CHROMEDRIVER: ${{ matrix.kind == 'cd' }}
      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ matrix.kind }}-${{ matrix.os }}-${{ matrix.head }}-${{ matrix.this_chunk }}-${{ matrix.this_repeat }}-artifacts
          path: logs
